name: Manual Live Publish

on:
  workflow_dispatch:
    inputs:
      slot:
        description: "اختر الفتحة: 0 (صباح) ، 1 (مساء) ، 2 (الاثنتان معًا)"
        required: false
        default: "2"

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      # إجبار النشر المباشر
      PUBLISH_MODE: live
      # اختياري: شغّل المحاولة الواحدة لمسار main.py (ينشر الفتحتين)
      RUN_ONCE: "1"
      USE_EXTERNAL_CRON: "0"

      # مفاتيح الصور (اختياري)
      PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
      PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}
      UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
      FEATURED_IMAGE_URL: ${{ secrets.FEATURED_IMAGE_URL }}

      # إعدادات الترند (اختياري)
      TREND_GEO: ${{ secrets.TREND_GEO }}
      TREND_GEO_LIST: ${{ secrets.TREND_GEO_LIST }}
      TOPIC_WINDOW_DAYS: ${{ secrets.TOPIC_WINDOW_DAYS }}
      TOPIC_POLICY: ${{ secrets.TOPIC_POLICY }}

      # ضبطات أخرى (اختياري)
      SAFE_CALLS_PER_MIN: "3"
      AI_MAX_RETRIES: "3"
      AI_BACKOFF_BASE: "4"
      TITLE_WINDOW: "40"

      # أسرار أساسية (إلزامية)
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      BLOG_URL: ${{ secrets.BLOG_URL }}
      CLIENT_ID: ${{ secrets.CLIENT_ID }}
      CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
      REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # إن كان لديك requirements.txt استخدمه؛ وإلا ثبّت الحزم مباشرة:
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install google-api-python-client google-auth \
                        requests feedparser backoff flask apscheduler \
                        markdown bleach
          fi

      # خيار 1: تنفيذ فتحة واحدة حسب الإدخال (0 أو 1) بدون تعديل الكود
      - name: Publish single slot (0 or 1)
        if: ${{ inputs.slot != '2' }}
        run: |
          python - <<'PY'
          import os
          os.environ["PUBLISH_MODE"] = "live"
          from main import make_article_once
          slot = int("${{ inputs.slot }}")
          if slot not in (0,1):
              raise SystemExit("slot must be 0 or 1")
          make_article_once(slot)
          PY

      # خيار 2: تنفيذ الفتحتين معًا (يستخدم منطق RUN_ONCE في main.py)
      - name: Publish both slots (RUN_ONCE)
        if: ${{ inputs.slot == '2' }}
        run: |
          PUBLISH_MODE=live RUN_ONCE=1 USE_EXTERNAL_CRON=0 python main.py
