name: Auto Publish (Live + Schedule)

on:
  schedule:
    # 07:00 و 15:00 UTC (تساوي 10:00 و 18:00 بغداد)
    - cron: "0 7 * * *"
    - cron: "0 15 * * *"
  workflow_dispatch:
    inputs:
      slot:
        description: "اختر الفتحة: 0 (صباح) ، 1 (مساء) ، 2 (الاثنتان معًا)"
        required: false
        default: "2"

concurrency:
  group: auto-publish
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      # نفرض النشر المباشر دائمًا هنا بغض النظر عن أي سيكريت قديم
      PUBLISH_MODE: live
      USE_EXTERNAL_CRON: "0"
      # نافذة منع تكرار المواضيع (افتراضي 14 لو السيكريت غير موجود)
      TOPIC_WINDOW_DAYS: ${{ secrets.TOPIC_WINDOW_DAYS || '14' }}
      # مفاتيح الصور (اختياري)
      PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
      PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}
      UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
      FEATURED_IMAGE_URL: ${{ secrets.FEATURED_IMAGE_URL }}
      # ضبطات أخرى
      SAFE_CALLS_PER_MIN: "3"
      AI_MAX_RETRIES: "3"
      AI_BACKOFF_BASE: "4"
      TITLE_WINDOW: "40"
      # أسرار أساسية
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      BLOG_URL: ${{ secrets.BLOG_URL }}
      CLIENT_ID: ${{ secrets.CLIENT_ID }}
      CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
      REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install google-api-python-client google-auth \
                        requests feedparser backoff flask apscheduler \
                        markdown bleach
          fi

      # تشغيل مجدول (schedule): ننشر فتحة واحدة حسب وقت تشغيل GitHub
      - name: Publish scheduled slot (UTC-based)
        if: ${{ github.event_name == 'schedule' }}
        run: |
          # احسب الساعة الحالية UTC لتحديد الفتحة
          H=$(date -u +%H)
          if [ "$H" = "07" ]; then SLOT=0; else SLOT=1; fi
          python - <<'PY'
          import os
          os.environ["PUBLISH_MODE"] = "live"
          from main import make_article_once
          make_article_once(int(os.environ.get("SLOT","0")))
          PY
        env:
          SLOT: ${{ env.SLOT || '' }}

      # تشغيل يدوي: حسب اختيار المستخدم
      - name: Publish single slot (manual 0 or 1)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.slot != '2' }}
        run: |
          python - <<'PY'
          import os
          os.environ["PUBLISH_MODE"] = "live"
          from main import make_article_once
          slot = int("${{ inputs.slot }}")
          if slot not in (0,1):
              raise SystemExit("slot must be 0 or 1")
          make_article_once(slot)
          PY

      - name: Publish both slots (manual 2)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.slot == '2' }}
        run: |
          PUBLISH_MODE=live RUN_ONCE=1 USE_EXTERNAL_CRON=0 python main.py
